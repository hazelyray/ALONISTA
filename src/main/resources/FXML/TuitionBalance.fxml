package com.example.system.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.stereotype.Component;

import com.example.system.dtos.LoginResponse;
import com.example.system.models.StudentBalance;
import com.example.system.models.User;
import com.example.system.repositories.UserRepository;
import com.example.system.session.SessionManager;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.Alert;
import javafx.scene.control.Label;
import javafx.scene.control.MenuItem;
import javafx.stage.Stage;
import javafx.stage.Window;

@Component
public class HomeController {

    @FXML
    private Label welcomeLabel;

    @FXML
    private Label tuitionBalanceLabel;

    @FXML
    private Label userNameLabel; // The label in top right that says "Welcome, Student"

    @Autowired
    private SessionManager sessionManager;
    
    @Autowired
    private ApplicationContext springContext;

    @Autowired
    private UserRepository userRepository;

    @FXML
    public void initialize() {
        System.out.println("HomeController loaded.");
        loadUserData();
    }

    private void loadUserData() {
        LoginResponse currentUser = sessionManager.getCurrentUser();
        
        if (currentUser != null) {
            System.out.println("Current user: " + currentUser.getUsername() + " - " + currentUser.getFullName());
            
            // Update the welcome labels with actual user data
            if (userNameLabel != null) {
                userNameLabel.setText("Welcome, " + currentUser.getFullName());
                System.out.println("Updated userNameLabel to: Welcome, " + currentUser.getFullName());
            } else {
                System.out.println("userNameLabel is null - check FXML fx:id");
            }
            
            if (welcomeLabel != null) {
                welcomeLabel.setText("Welcome Back, " + currentUser.getFullName() + "! üüßÔ∏è");
                System.out.println("Updated welcomeLabel to: Welcome Back, " + currentUser.getFullName() + "! üüßÔ∏è");
            } else {
                System.out.println("welcomeLabel is null - check FXML fx:id");
            }

            // Load actual balance data from database
            User user = userRepository.findByUsername(currentUser.getUsername()).orElse(null);
            if (user != null) {
                System.out.println("Found user in database: " + user.getFullName());
                
                StudentBalance balance = user.getStudentBalance();
                if (balance != null) {
                    System.out.println("Student balance found:");
                    System.out.println("  Total Fee: " + balance.getTotalTuitionFee());
                    System.out.println("  Amount Paid: " + balance.getAmountPaid());
                    System.out.println("  Remaining: " + balance.getRemainingBalance());
                    
                    if (tuitionBalanceLabel != null) {
                        String balanceText = "‚Ç±" + String.format("%,.2f", balance.getRemainingBalance());
                        tuitionBalanceLabel.setText(balanceText);
                        System.out.println("Updated tuitionBalanceLabel to: " + balanceText);
                    } else {
                        System.out.println("tuitionBalanceLabel is null - check FXML fx:id");
                    }
                } else {
                    System.out.println("No student balance found for user");
                    if (tuitionBalanceLabel != null) {
                        tuitionBalanceLabel.setText("‚Ç±0.00");
                    }
                }
            } else {
                System.out.println("User not found in database for username: " + currentUser.getUsername());
                if (tuitionBalanceLabel != null) {
                    tuitionBalanceLabel.setText("‚Ç±0.00");
                }
            }
        } else {
            System.out.println("No user found in session");
        }
    }

    // Called by FXML: onAction="#handleLogout"
    @FXML
    private void handleLogout(ActionEvent event) {
        logoutAndNavigateToLogin(event);
    }

    // Your old method, still allowed
    @FXML
    private void handleSignOut(ActionEvent event) {
        logoutAndNavigateToLogin(event);
    }

    private void logoutAndNavigateToLogin(ActionEvent event) {
        // Clear the session
        if (sessionManager != null) {
            sessionManager.clearSession();
            System.out.println("Session cleared on logout");
        }
        
        navigateToLogin(event);
    }

    // Only used if Homepage.fxml has onAction="#handleTuitionBalance"
    @FXML
    private void handleTuitionBalance(ActionEvent event) {
        try {
            // Use the exact path - /FXML/TuitionBalance.fxml (uppercase)
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/FXML/TuitionBalance.fxml"));
            loader.setControllerFactory(springContext::getBean);
            Parent root = loader.load();

            Stage stage = getStageFromEvent(event);
            stage.setScene(new Scene(root));
            stage.setTitle("Tuition Balance");
            stage.show();

            System.out.println("Successfully loaded tuition balance from /FXML/TuitionBalance.fxml");

        } catch (Exception e) {
            e.printStackTrace();
            showError("Failed to load Tuition Balance page: " + e.getMessage());
        }
    }

    // Load Login.fxml
    private void navigateToLogin(ActionEvent event) {
        try {
            // Use the exact path - /FXML/Login.fxml (uppercase)
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/FXML/Login.fxml"));
            loader.setControllerFactory(springContext::getBean);
            Parent root = loader.load();

            Stage stage = getStageFromEvent(event);
            if (stage != null) {
                stage.setScene(new Scene(root));
                stage.setTitle("Login");
                stage.show();
                System.out.println("Successfully loaded login page from /FXML/Login.fxml");
            } else {
                showError("Could not determine current window");
            }

        } catch (Exception e) {
            e.printStackTrace();
            showError("Failed to load Login page: " + e.getMessage());
            
            // Debug
            try {
                java.net.URL loginUrl = getClass().getResource("/FXML/Login.fxml");
                System.out.println("Login FXML URL: " + loginUrl);
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
    }

    // Get Stage from event (works for MenuItem and Button)
    private Stage getStageFromEvent(ActionEvent event) {
        if (event == null) {
            // Fallback: get any open stage
            for (Window window : Window.getWindows()) {
                if (window instanceof Stage && window.isShowing()) {
                    return (Stage) window;
                }
            }
            return null;
        }
        
        Object source = event.getSource();

        try {
            if (source instanceof MenuItem) {
                MenuItem item = (MenuItem) source;
                return (Stage) item.getParentPopup().getOwnerWindow();
            } else {
                return (Stage) ((javafx.scene.Node) source).getScene().getWindow();
            }
        } catch (Exception e) {
            // Fallback: find any open window
            for (Window w : Window.getWindows()) {
                if (w instanceof Stage && w.isShowing()) {
                    return (Stage) w;
                }
            }
            return null;
        }
    }

    private void showError(String message) {
        Alert alert = new Alert(Alert.AlertType.ERROR, message);
        alert.setHeaderText(null);
        alert.show();
    }
}